# ============================================
# User-Friendly tmux Configuration
# Prefix is Ctrl+Space (avoids conflict with Claude Code's Ctrl+b)
# ============================================

# --- Prefix Key ---
# Ctrl+Space instead of the default Ctrl+b. Ergonomic, no shell conflicts,
# and frees Ctrl+b for Claude Code's "background task" shortcut.
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# --- Basic Settings ---
# Use tmux-256color for truecolor support (16M colors instead of 256).
# If colors look wrong in your terminal, revert to "screen-256color".
set -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",xterm-256color:Tc"
set -g history-limit 50000
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g display-time 2000
set -g escape-time 0

# --- Status Bar ---
set -g status-style 'bg=#333333 fg=#ffffff'
set -g status-left '#[bg=#5555ff,fg=#ffffff,bold] #S #[default] '
set -g status-left-length 30
set -g status-right '#[fg=#888888] %Y-%m-%d #[fg=#ffffff,bold]%H:%M '
set -g status-right-length 50
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format '#[bg=#5555ff,fg=#ffffff,bold] #I:#W '

# --- Pane Borders ---
set -g pane-border-style 'fg=#555555'
set -g pane-active-border-style 'fg=#5555ff,bold'
# pane-border-lines requires tmux 3.2+
if-shell '[ "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" = "$(printf "%s\n3.2\n" "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" | sort -V | tail -1)" ]' \
  'set -g pane-border-lines heavy'

# --- Active Pane Indicator ---
# Inactive panes get a subtle navy tint + muted text so the focused pane stands out.
# To adjust: raise bg hex values for less dimming, lower for more dimming.
set -g window-style 'fg=#888899,bg=#2b2b3d'
# Active pane uses the default background color (no tint).
set -g window-active-style 'bg=default'

# --- Blinking Cursor (tmux 3.4+) ---
if-shell '[ "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" = "$(printf "%s\n3.4\n" "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" | sort -V | tail -1)" ]' \
  'set -g cursor-style blinking-block'

# --- Menus (tmux 3.2+ only — display-menu was added in 3.2) ---
# On older tmux, prefix + ? falls back to list-keys.
if-shell '[ "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" = "$(printf "%s\n3.2\n" "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" | sort -V | tail -1)" ]' \
  'source-file ~/.tmux/menus.conf' \
  'bind-key ? list-keys'

# --- Intuitive Split Bindings ---
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# --- Easy Pane Navigation (prefix + h/j/k/l) ---
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# --- Pane Resizing (prefix + H/J/K/L) ---
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5

# --- Reload Config ---
bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# --- Copy Mode (vi style) ---
setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# --- Don't exit copy mode on mouse drag end ---
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# --- macOS-Only Overrides (Light Theme) ---
# Local (macOS) uses a full light theme so you can instantly tell it apart
# from the dark devbox. Session name badge is color-coded:
#   green = dx (tooling), magenta = feat (features), blue = anything else.
# Status-right shows the focused pane's title for extra context.
if-shell '[ "$(uname -s)" = "Darwin" ]' \
  'set -g status-style "bg=#e0e0e0 fg=#333333" ; \
   set -g status-left "#{?#{==:#S,dx},#[bg=#338833],#{?#{==:#S,feat},#[bg=#883388],#[bg=#5555ff]}}#[fg=#ffffff,bold] #S #[default] " ; \
   set -g status-right "#[fg=#666666]#{pane_title} #[fg=#bbbbbb]│ #[fg=#555555]%H:%M " ; \
   set -g status-right-length 80 ; \
   setw -g window-status-format " #I:#W " ; \
   setw -g window-status-current-format "#[bg=#5555ff,fg=#ffffff,bold] #I:#W " ; \
   set -g pane-border-style "fg=#cccccc" ; \
   set -g pane-active-border-style "fg=#5555ff,bold" ; \
   set -g window-style "fg=#888888,bg=#d0d0d0" ; \
   set -g window-active-style "fg=#1a1a1a,bg=#ffffff"'

# --- Nested Tmux Toggle (F12, macOS only) ---
# Press F12 to "pass through" keys to a remote/inner tmux session (e.g. devbox).
# Local status bar dims + shows "REMOTE" so you know keys are going through.
# Press F12 again to regain local control.
# Only loaded on macOS — the remote side should NOT have this binding,
# otherwise F12 would double-toggle and cancel itself out.
if-shell '[ "$(uname -s)" = "Darwin" ]' \
  'bind -T root F12 \
    set prefix None \; \
    set key-table off \; \
    set status-style "bg=#1a1a1a fg=#555555" \; \
    set status-right "#[fg=#cc6666,bold] REMOTE #[fg=#555555]│ #[fg=#555555]%H:%M " \; \
    refresh-client -S ; \
  bind -T off F12 \
    set prefix C-Space \; \
    set -u key-table \; \
    set -u status-style \; \
    set -u status-right \; \
    refresh-client -S'

# --- Plugins (via TPM) ---
# Install plugins:  prefix + I   (capital I)
# Update plugins:   prefix + U
# Uninstall:        prefix + alt + u
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'alexwforsythe/tmux-which-key'    # Interactive keybinding cheatsheet
set -g @plugin 'tmux-plugins/tmux-resurrect'      # Save/restore sessions across restarts (prefix + Ctrl-s / Ctrl-r)
set -g @plugin 'tmux-plugins/tmux-continuum'       # Auto-saves sessions in the background
set -g @plugin 'christoomey/vim-tmux-navigator'    # Seamless Ctrl+hjkl navigation between vim/tmux panes

# --- Session Persistence (resurrect + continuum) ---
# Sessions auto-save every 15 min and auto-restore when tmux starts.
# Manual save: prefix + Ctrl-s   Manual restore: prefix + Ctrl-r
# Saved session data lives in ~/.tmux/resurrect/
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
set -g @resurrect-capture-pane-contents 'on'

# Keep this line at the very bottom — TPM needs it to load plugins.
run '~/.tmux/plugins/tpm/tpm'
